import Vue from 'vue'
import findVueFile from './findVueFile.js'
import extendsVueFile from './extendsVueFile.js'
let xlwComponentVueFiles = findVueFile(require.context('../../../../xlw-components/', true, /\.vue$/), xlwRequireFile, 'xlw-components/')
let componentVueFiles = findVueFile(require.context('../../../../src/components/', true, /\.vue$/), requireFile, 'src/components/')
let functionalComponentContext = require.context('../../../../src/components/', true, /component\..+index\.js$/)
functionalComponentContext.keys().forEach(path => {
  functionalComponentContext(path)
})
// 组件的 *.index.vue
let xlwIndexFiles = xlwComponentVueFiles.filter(item => item.fileName.match(/\.index\.vue$/))
let indexFiles = componentVueFiles.filter(item => item.fileName.match(/\.index\.vue$/))
xlwComponentVueFiles.forEach(item => {
  item.componentName = 't-' + item.fileName.replace(/\.vue$/, '')
})
componentVueFiles.forEach(item => {
  item.componentName = 't-' + item.fileName.replace(/\.vue$/, '')
})
xlwIndexFiles.forEach(item => {
  item.componentName = 't-' + item.fileName.replace(/.\index\.vue$/, '').replace(/^component\./, '')
})
indexFiles.forEach(item => {
  item.componentName = 't-' + item.fileName.replace(/.\index\.vue$/, '').replace(/^component\./, '')
})
let resultXlwComponent = extendsVueFile(xlwIndexFiles, xlwComponentVueFiles)
let resultComponent = extendsVueFile(indexFiles, componentVueFiles)
let componentList = []
for (let componentName in resultXlwComponent) {
  Vue.component(componentName, resultXlwComponent[componentName])
  componentList.push(componentName)
}
for (let componentName in resultComponent) {
  if (componentList.indexOf(componentName) > -1) {
    throw new Error(indexPath + '\n存在同名组件' + componentName + '\ncomponents中与xlw-components中的组件同名')
  }
  Vue.component(componentName, resultComponent[componentName])
}
// 加载 src/components/ 下的组件
function requireFile (filename) {
  filename = filename.replace(/^\./, '').replace(/^\//, '')
  return require('../../../../src/components/' + filename)
}
// 加载 xlw-components/ 下的组件
function xlwRequireFile (filename) {
  filename = filename.replace(/^\./, '').replace(/^\//, '').replace('node_modules/', '')
  return require('../../../../xlw-components/node_modules/' + filename)
}
